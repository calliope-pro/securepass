# Railway IaC Configuration for SecurePass Platform (Monorepo)
# Each service uses its own rootDirectory for isolated deployment

[backend]
[backend.build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"
rootDirectory = "backend"
# 監視パターン: バックエンドディレクトリのみ監視
watchPatterns = [
  "backend/**"
]

[backend.deploy]
preDeployCommand = ["uv run prisma migrate deploy", "uv run upsert-initial-plans"]
startCommand = "uv run uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

[frontend]
[frontend.build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"
rootDirectory = "frontend"
# 監視パターン: フロントエンドディレクトリのみ監視（API変更時は手動デプロイ）
watchPatterns = [
  "frontend/**"
]

[frontend.deploy]
# API生成は手動で実行（backend URL必要のため）
startCommand = "PORT=${PORT:-3000} yarn start"
healthcheckPath = "/"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

[worker]
[worker.build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile"
rootDirectory = "backend"
# 監視パターン: バックグラウンドタスク関連ファイルのみ
watchPatterns = [
  "backend/app/background/**",
  "backend/app/services/**",
  "backend/app/core/**",
  "backend/pyproject.toml"
]

[worker.deploy]
startCommand = "uv run worker"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 5
